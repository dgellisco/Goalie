var db=require("../../models"),moment=require("moment");module.exports=function(e,a){return console.log("running callback function to run calcs"),"POST"==e?console.log("userid is "+e+", error"):void db.Users.findOne({where:{id:e}}).then(function(n){db.Financials.findAll({where:{userid:e}}).then(function(e){var o={};for(i=0;i<e.length;i++){o.balancestart=e[0].balance;var l=e.length-1;if(o.balance=e[l].balance,e.length>1){var l=e.length-2;o.balanceprevious=e[l].balance,o.balanceremaining=n.goalamount-o.balance}else o.balanceprevious=e[0].balance,o.balanceremaining=n.goalamount-o.balance;o.balanceremaining<0&&(o.balanceremaining=0),o.income=e[0].income}o.rosrecommended=(.15*o.income).toFixed(2),o.rossincestart=(o.balance-o.balancestart).toFixed(2),o.rossinceprevious=(o.balance-o.balanceprevious).toFixed(2),o.progress=(o.balance/n.goalamount*100).toFixed(1),o.progress>100&&(o.progress=100);var s=moment(),r=moment();r.diff(s,"days");console.log("balance is "+o.balance),console.log("progress is "+o.progress),console.log("ros "+o.rosrecommended);var t=(o.balanceremaining/o.rosrecommended*7).toFixed(0);if(console.log("days remaining "+t),t>0){n.goaldate=0,n.goaldate=moment().add(t,"days").format("dddd, MMMM Do YYYY"),Date.getFormattedDateDiff=function(e,a){for(var n=moment(e),o=moment(a),l=["years","months","weeks","days"],s=[],r=0;r<l.length;r++){var t=o.diff(n,l[r]);n.add(t,l[r]),s.push(t+" "+l[r])}return s=s.join(", "),console.log("out",s),0==s.indexOf("1 years, ")&&(s=s.replace("1 years, "," 1 year, ")),s.includes("0 years, ")&&(s=s.replace("0 years, ","")),s.includes(" 1 months, ")&&(s=s.replace(" 1 months, "," 1 month, ")),s.includes(" 0 months, ")&&(s=s.replace(" 0 months, "," ")),s.includes(" 1 weeks, ")&&(s=s.replace(" 1 weeks, "," 1 week, ")),s.includes(" 0 weeks, ")&&(s=s.replace(" 0 weeks, "," ")),s.includes(" 1 days")&&(s=s.replace(" 1 days","1 day")),s.includes(", 0 days")&&(s=s.replace(", 0 days","")),s.includes("test, ")&&(s=s.replace("test, ","")),s};var c=new Date,d=moment().add(t,"days").toDate();y2k=new Date(2e3,0,1),console.log(c),console.log(d),console.log(y2k),console.log("Time since New Year: "+Date.getFormattedDateDiff(y2k,c)),console.log("Time until goal date: "+Date.getFormattedDateDiff(c,d)),o.goaltimeremaining=Date.getFormattedDateDiff(c,d)}else o.goaltimeremaining="Goal achieved!",n.goaldate="Goal achieved!";var m={userFinancials:o,userData:n};console.log(o),console.log("finished callback function to run calcs"),a(m)})})};